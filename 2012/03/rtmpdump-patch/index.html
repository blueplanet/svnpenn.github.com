<!DOCTYPE html>
<html>

<meta charset='utf-8'>

<title>Make a commit from a patch</title>

<link rel='stylesheet' href='/css/style.css'>
<link rel='stylesheet' href='/css/coderay.css'>

<body>

<h1>
<a href='/'>Steven&rsquo;s Blog</a>
</h1>

<div id='container'>
	
	<h2>Make a commit from a patch</h2>
	
	<div><div class="CodeRay">
  <div class="code"><pre><span class="directive">#!/bin/sh</span>
<span class="comment"># Create a commit from a patch</span>
<span class="instance-variable">patch_author</span>=KSV
<span class="instance-variable">patch_branch</span>=KSV
<span class="instance-variable">patch_file</span>=Patch.diff
<span class="instance-variable">url_mine</span>=git@github.com<span class="reserved">:</span>svnpenn/rtmpdump.git
<span class="instance-variable">url_upstream</span>=git<span class="reserved">:</span>//git.ffmpeg.org/rtmpdump
<span class="comment">########################################################################</span>
mingw-get install msys-coreutils

<span class="comment"># Get my repo</span>
git clone <span class="instance-variable">$url_mine</span> dir_mine
<span class="function">cd</span> dir_mine
git checkout <span class="instance-variable">$patch_branch</span>
<span class="comment"># Empty my repo, except &quot;.git&quot;</span>
rm -r *
<span class="function">cd</span> -

<span class="comment"># Get upstream repo</span>
git clone <span class="instance-variable">$url_upstream</span> dir_upstream
<span class="function">cd</span> dir_upstream
git apply ../<span class="instance-variable">$patch_file</span> <span class="integer">2</span>&gt;nul || git apply -p0 ../<span class="instance-variable">$patch_file</span> || <span class="reserved">{</span>
    <span class="function">echo</span> <span class="string">'Patch failed!'</span>
    <span class="function">exit</span>
<span class="reserved">}</span>
<span class="comment"># Copy patched files over</span>
cp -r * ../dir_mine
<span class="function">cd</span> -

<span class="comment"># Get author modify time</span>
<span class="instance-variable">modify_time</span>=<span class="shell"><span class="delimiter">$(</span>stat -c %y <span class="string"><span class="delimiter">&quot;</span><span class="instance-variable">$patch_file</span><span class="delimiter">&quot;</span></span><span class="delimiter">)</span></span>
<span class="function">echo</span> <span class="instance-variable">$modify_time</span>

<span class="comment"># Commit</span>
<span class="function">cd</span> dir_mine
git add -A
git commit --author <span class="string"><span class="delimiter">&quot;</span><span class="instance-variable">$patch_author</span><span class="delimiter">&quot;</span></span> --date <span class="string"><span class="delimiter">&quot;</span><span class="instance-variable">$modify_time</span><span class="delimiter">&quot;</span></span>
</pre></div>
</div>
</div>

<h3 id="links">Links</h3>
<ul>
  <li><a href="http://github.com/svnpenn/dotfiles/blob/master/bin/rtmpdump-patch.sh">github.com/svnpenn/dotfiles/blob/master/bin/rtmpdump-patch.sh</a></li>
</ul>



</div>
</body>
</html>